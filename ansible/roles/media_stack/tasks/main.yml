---
- name: Ensure media stack base directory exists
  file:
    path: /srv/stacks/media
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure media config directory exists
  file:
    path: /srv/stacks/media/config
    state: directory
    owner: 1000
    group: 1000
    mode: '0755'

- name: Ensure media downloads directory exists
  file:
    path: /srv/stacks/media/downloads
    state: directory
    owner: 1000
    group: 1000
    mode: '0755'

- name: Ensure media library directory exists
  file:
    path: /srv/stacks/media/media
    state: directory
    owner: 1000
    group: 1000
    mode: '0755'

# Copy the compose and env from your repo into place on the media node
- name: Deploy docker-compose.yml for media stack
  copy:
    src: "{{ playbook_dir }}/../../stacks/media/docker-compose.yml"
    dest: /srv/stacks/media/docker-compose.yml
    owner: root
    group: root
    mode: '0644'

- name: Deploy .env for media stack
  copy:
    src: "{{ playbook_dir }}/../../stacks/media/.env"
    dest: /srv/stacks/media/.env
    owner: root
    group: root
    mode: '0640'

- name: Bring up media stack via Docker Compose v2
  community.docker.docker_compose_v2:
    project_src: /srv/stacks/media
    files:
      - docker-compose.yml
    state: present
    remove_orphans: true
  register: media_stack_result

- name: Show media stack changes
  debug:
    var: media_stack_result
  when: media_stack_result is changed
