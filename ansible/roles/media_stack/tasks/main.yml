---
# Role: media_stack
# Tasks to deploy/update the media stack

- name: Ensure base media directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop:
    - { path: "{{ CONFIG_ROOT }}",  owner: "root", group: "root" }
    - { path: "{{ CONFIG_DIR }}",   owner: "{{ MEDIA_PUID }}", group: "{{ MEDIA_PGID }}" }
    - { path: "{{ DOWNLOAD_DIR }}", owner: "{{ MEDIA_PUID }}", group: "{{ MEDIA_PGID }}" }
    - { path: "{{ MEDIA_DIR }}",    owner: "{{ MEDIA_PUID }}", group: "{{ MEDIA_PGID }}" }

- name: Deploy docker-compose.yml for media stack
  ansible.builtin.copy:
    src: "{{ MEDIA_COMPOSE_SRC }}"
    dest: "{{ MEDIA_COMPOSE_DEST }}"
    owner: root
    group: root
    mode: '0644'

- name: Render .env for media stack from template
  ansible.builtin.template:
    src: "{{ MEDIA_ENV_TEMPLATE }}"
    dest: "{{ MEDIA_ENV_DEST }}"
    owner: root
    group: root
    mode: '0640'

- name: Bring up media stack via Docker Compose v2
  become: true
  community.docker.docker_compose_v2:
    project_src: "{{ CONFIG_ROOT }}"
    files:
      - "{{ MEDIA_COMPOSE_DEST | basename }}"
    state: present
    remove_orphans: true
  register: media_stack_result

- name: Show media stack changes
  ansible.builtin.debug:
    var: media_stack_result
  when: media_stack_result is changed
