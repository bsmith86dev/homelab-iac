---
# roles/media-stack/tasks/main.yml
# Deploy full Jellyfin media stack using docker-compose

- name: Ensure media stack directory exists
  file:
    path: /srv/stacks/media
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy docker-compose.yml for media stack
  copy:
    dest: /srv/stacks/media/docker-compose.yml
    mode: '0644'
    content: |
      services:
        gluetun:
          image: qmcgaw/gluetun
          container_name: gluetun
          cap_add:
            - NET_ADMIN
          devices:
            - /dev/net/tun:/dev/net/tun
          ports:
            - "8080:8080"
            - "9090:9090"
            - "8081:8081"
            - "6881:6881"
            - "6881:6881/udp"
            - "6789:6789"
            - "563:563"
          networks:
            - gluetun
          restart: unless-stopped
          env_file:
            - ./.env
          volumes: []

        qbittorrent:
          image: lscr.io/linuxserver/qbittorrent:latest
          container_name: qbittorrent
          network_mode: service:gluetun
          depends_on:
            - gluetun
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
          volumes:
            - ${DOWNLOAD_DIR}/incomplete:/downloads/incomplete
            - ${DOWNLOAD_DIR}/complete:/downloads/complete
            - ${CONFIG_DIR}/qbittorrent:/config
          restart: unless-stopped
          env_file:
            - ./.env

        sabnzbd:
          image: lscr.io/linuxserver/sabnzbd:latest
          container_name: sabnzbd
          network_mode: service:gluetun
          depends_on:
            - gluetun
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
          volumes:
            - ${DOWNLOAD_DIR}/complete:/config/Downloads/complete
            - ${DOWNLOAD_DIR}/incomplete:/config/Downloads/incomplete
            - ${CONFIG_DIR}/sabnzbd:/config
          restart: unless-stopped
          env_file:
            - ./.env

        jellyfin:
          image: lscr.io/linuxserver/jellyfin:latest
          container_name: jellyfin
          networks: [media]
          ports:
            - "8096:8096"
            - "8920:8920"
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
            - TZ=${TZ}
            - UMASK=002
          tmpfs:
            - /transcodes:size=${TRANSCODE_SIZE},exec,mode=1777
          volumes:
            - ${CONFIG_DIR}/jellyfin:/config
            - ${CONFIG_DIR}/jellyfin/cache:/cache
            - ${MEDIA_DIR}/movies:/movies
            - ${MEDIA_DIR}/tvseries:/tv
            - ${MEDIA_DIR}/adult:/adult
          devices:
            - /dev/dri:/dev/dri
          group_add:
            - "104"
            - "44"
          restart: unless-stopped
          env_file:
            - ./.env

        radarr:
          image: lscr.io/linuxserver/radarr:latest
          container_name: radarr
          networks:
            - media
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
          volumes:
            - ${MEDIA_DIR}/movies:/movies
            - ${DOWNLOAD_DIR}/complete:/downloads
            - ${CONFIG_DIR}/radarr:/config
          ports:
            - "7878:7878"
          restart: unless-stopped
          env_file:
            - ./.env

        bazarr:
          image: lscr.io/linuxserver/bazarr:latest
          container_name: bazarr
          networks:
            - media
          ports:
            - "6767:6767"
          restart: unless-stopped
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
          volumes:
            - ${CONFIG_DIR}/bazarr/config:/config
            - ${MEDIA_DIR}/movies:/movies
            - ${MEDIA_DIR}/tvseries:/tv
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:6767"]
            interval: 1m30s
            timeout: 10s
            retries: 3
          env_file:
            - ./.env

        lazylibrarian:
          image: lscr.io/linuxserver/lazylibrarian:latest
          container_name: lazylibrarian
          networks:
            - media
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
          volumes:
            - ${CONFIG_DIR}/lazylibrarian:/config
            - ${DOWNLOAD_DIR}/complete:/downloads
            - ${MEDIA_DIR}/books:/books
          ports:
            - "5299:5299"
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:5299"]
            interval: 1m30s
            timeout: 10s
            retries: 3
          env_file:
            - ./.env

        huntarr:
          container_name: huntarr
          image: huntarr/huntarr:latest
          networks:
            - media
          ports:
            - "9705:9705"
          restart: always
          volumes:
            - ${CONFIG_DIR}/huntarr:/config
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9705"]
            interval: 1m30s
            timeout: 10s
            retries: 3
          env_file:
            - ./.env

        jellyseerr:
          container_name: jellyseerr
          image: fallenbagel/jellyseerr:latest
          networks:
            - media
          ports:
            - "5055:5055"
          restart: unless-stopped
          volumes:
            - ${CONFIG_DIR}/jellyseerr:/app/config
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:5055"]
            interval: 1m30s
            timeout: 10s
            retries: 3
          env_file:
            - ./.env

        prowlarr:
          container_name: prowlarr
          image: lscr.io/linuxserver/prowlarr:latest
          networks:
            - media
          ports:
            - "9696:9696"
          volumes:
            - ${CONFIG_DIR}/prowlarr/config:/config
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9696"]
            interval: 1m30s
            timeout: 10s
            retries: 3
          env_file:
            - ./.env

        sonarr:
          image: lscr.io/linuxserver/sonarr:latest
          container_name: sonarr
          networks:
            - media
          ports:
            - "8989:8989"
          restart: unless-stopped
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
          volumes:
            - ${CONFIG_DIR}/sonarr/config:/config
            - ${MEDIA_DIR}/tvseries:/tv
            - ${DOWNLOAD_DIR}/complete:/downloads
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8989"]
            interval: 1m30s
            timeout: 10s
            retries: 3
          env_file:
            - ./.env

        unpackerr:
          container_name: unpackerr
          image: ghcr.io/hotio/unpackerr
          networks:
            - media
          restart: unless-stopped
          environment:
            - PUID=${PUID}
            - PGID=${PGID}
          volumes:
            - ${CONFIG_DIR}/unpackerr:/config
            - ${DOWNLOAD_DIR}/complete:/downloads
          env_file:
            - ./.env

        whisparr:
          container_name: whisparr
          image: ghcr.io/hotio/whisparr:nightly
          networks:
            - media
          ports:
            - "6969:6969"
          restart: unless-stopped
          volumes:
            - ${CONFIG_DIR}/whisparr/config:/config
            - ${MEDIA_DIR}/adult:/adult
            - ${DOWNLOAD_DIR}/complete:/downloads
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:6969"]
            interval: 1m30s
            timeout: 10s
            retries: 3
          env_file:
            - ./.env

        flaresolverr:
          container_name: flaresolverr
          image: ghcr.io/flaresolverr/flaresolverr:latest
          networks:
            - media
          ports:
            - "8191:8191"
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8191"]
            interval: 1m30s
            timeout: 10s
            retries: 3
          env_file:
            - ./.env

      networks:
        media:
          name: media
        gluetun:
          name: gluetun

- name: Deploy .env for media stack
  copy:
    dest: /srv/stacks/media/.env
    mode: '0644'
    content: |
      # Basic identity for media containers
      PUID=1000
      PGID=1000
      TZ=America/Chicago

      # Where configs live on the host
      CONFIG_DIR=/srv/media-config

      # Where media lives on the host
      MEDIA_DIR=/srv/media

      # Where downloads live on the host
      DOWNLOAD_DIR=/srv/downloads

      # Jellyfin transcode tmpfs size
      TRANSCODE_SIZE=8G

- name: Ensure media config directory exists
  file:
    path: /srv/media-config
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure media library directory exists
  file:
    path: /srv/media
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create subfolders for media types
  file:
    path: "/srv/media/{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - movies
    - tvseries
    - adult
    - books

- name: Ensure downloads root directory exists
  file:
    path: /srv/downloads
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure downloads subfolders exist
  file:
    path: "/srv/downloads/{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - complete
    - incomplete

- name: Bring up media stack with docker-compose
  command: docker-compose up -d
  args:
    chdir: /srv/stacks/media
  register: compose_result
  changed_when: >-
    'Creating' in compose_result.stdout or
    'Recreating' in compose_result.stdout or
    'Starting' in compose_result.stdout

